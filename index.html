<!DOCTYPE html>
<html lang="zh">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>Starry Echoes: The Geographer's Maze</title>
Â  Â  <style>
Â  Â  Â  Â  body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; touch-action: none; user-select: none; }
Â  Â  Â  Â  
Â  Â  Â  Â  canvas { 
Â  Â  Â  Â  Â  Â  display: block; width: 100vw; height: 100vh; object-fit: contain;
Â  Â  Â  Â  Â  Â  image-rendering: pixelated; 
Â  Â  Â  Â  }

Â  Â  Â  Â  #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
Â  Â  Â  Â  .hud { position: absolute; color: #fff; text-shadow: 2px 2px 0 #000; font-weight: bold; pointer-events: none; }
Â  Â  Â  Â  #lives { top: 20px; left: 20px; font-size: 30px; }
Â  Â  Â  Â  #score-board { top: 20px; right: 20px; font-size: 24px; text-align: right; }
Â  Â  Â  Â  
Â  Â  Â  Â  #joystick-zone { position: absolute; bottom: 50px; left: 50px; width: 150px; height: 150px; pointer-events: auto; z-index: 50; }
Â  Â  Â  Â  #joystick-knob { position: absolute; width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 10px #fff; pointer-events: none; }
Â  Â  Â  Â  #joystick-base { width: 100%; height: 100%; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; background: rgba(0,0,0,0.2); }

Â  Â  Â  Â  .modal { 
Â  Â  Â  Â  Â  Â  position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.95); z-index: 100; 
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; justify-content: center; align-items: center; 
Â  Â  Â  Â  Â  Â  color: #fff; text-align: center; padding: 20px; box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  .hidden { display: none !important; }
Â  Â  Â  Â  
Â  Â  Â  Â  h1 { font-size: 40px; margin-bottom: 10px; color: #f9d71c; }
Â  Â  Â  Â  p { font-size: 18px; line-height: 1.6; max-width: 600px; margin: 0 auto 20px auto; }
Â  Â  Â  Â  
Â  Â  Â  Â  .btn { 
Â  Â  Â  Â  Â  Â  background: #2b5fa3; color: #fff; border: 2px solid #f9d71c; 
Â  Â  Â  Â  Â  Â  padding: 15px 40px; font-size: 20px; cursor: pointer; margin: 10px; 
Â  Â  Â  Â  Â  Â  border-radius: 10px; font-family: inherit; transition: 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn:active { transform: scale(0.95); }
Â  Â  Â  Â  .lang-btn { width: 120px; display: inline-block; }

Â  Â  Â  Â  #story-box { 
Â  Â  Â  Â  Â  Â  background: rgba(0, 20, 40, 0.9); border: 4px solid #f9d71c; 
Â  Â  Â  Â  Â  Â  border-radius: 15px; padding: 30px; max-width: 80%;
Â  Â  Â  Â  }
Â  Â  Â  Â  #story-title { color: #f9d71c; font-size: 24px; margin-bottom: 15px; }
Â  Â  Â  Â  #story-content { font-size: 18px; text-align: left; min-height: 100px; }

Â  Â  Â  Â  /* å¼€å§‹ç•Œé¢èƒŒæ™¯ */
Â  Â  Â  Â  #start-screen {
Â  Â  Â  Â  Â  Â  background-image: url('bg_start.jpg');
Â  Â  Â  Â  Â  Â  background-size: cover;
Â  Â  Â  Â  Â  Â  background-position: center;
Â  Â  Â  Â  Â  Â  background-repeat: no-repeat;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* éŸ³ä¹æŒ‰é’®åœ¨å³ä¸‹è§’ */
Â  Â  Â  Â  #music-btn {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 20px; Â /* ä»topæ”¹ä¸ºbottom */
Â  Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.2);
Â  Â  Â  Â  Â  Â  border: 2px solid #f9d71c;
Â  Â  Â  Â  Â  Â  color: #f9d71c;
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  z-index: 200;
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* æ•…äº‹èƒŒæ™¯å›¾ç‰‡ */
Â  Â  Â  Â  #story-bg-img {
Â  Â  Â  Â  Â  Â  max-width: 90%;
Â  Â  Â  Â  Â  Â  max-height: 40vh;
Â  Â  Â  Â  Â  Â  margin: 20px auto;
Â  Â  Â  Â  Â  Â  border: 3px solid #f9d71c;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

Â  Â  <canvas id="gameCanvas"></canvas>

Â  Â  <!-- èƒŒæ™¯éŸ³ä¹ -->
Â  Â  <audio id="bgMusic" loop>
Â  Â  Â  Â  <source src="bgm.mp3" type="audio/mpeg">
Â  Â  Â  Â  Your browser does not support the audio element.
Â  Â  </audio>
Â  Â  
Â  Â  <!-- éŸ³ä¹æŒ‰é’®ç§»åˆ°å³ä¸‹è§’ -->
Â  Â  <div id="music-btn" onclick="toggleMusic()">ğŸµ</div>

Â  Â  <div id="ui-layer">
Â  Â  Â  Â  <div id="lives" class="hud">â¤ï¸â¤ï¸â¤ï¸</div>
Â  Â  Â  Â  <div id="score-board" class="hud">
Â  Â  Â  Â  Â  Â  LV <span id="level-num">1</span><br>
Â  Â  Â  Â  Â  Â  <span id="collect-text">0%</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="joystick-zone">
Â  Â  Â  Â  Â  Â  <div id="joystick-base"></div>
Â  Â  Â  Â  Â  Â  <div id="joystick-knob"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- å¼€å§‹ç•Œé¢ -->
Â  Â  <div id="start-screen" class="modal">
Â  Â  Â  Â  <h1 style="font-family: serif; font-style: italic;">Starry Echoes</h1>
Â  Â  Â  Â  <p style="color: #aaa;">The Geographer's Maze</p>
Â  Â  Â  Â  <div style="margin-top: 40px;">
Â  Â  Â  Â  Â  Â  <button class="btn lang-btn" onclick="selectLang('CN')">ä¸­æ–‡</button>
Â  Â  Â  Â  Â  Â  <button class="btn lang-btn" onclick="selectLang('BM')">Melayu</button>
Â  Â  Â  Â  Â  Â  <button class="btn lang-btn" onclick="selectLang('EN')">English</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- å…³å¡å†…å‰§æƒ… -->
Â  Â  <div id="story-modal" class="modal hidden">
Â  Â  Â  Â  <div id="story-box">
Â  Â  Â  Â  Â  Â  <div id="story-title">HISTORY FOUND</div>
Â  Â  Â  Â  Â  Â  <div id="story-content">...</div>
Â  Â  Â  Â  Â  Â  <button class="btn" onclick="closeStory()">â–¼</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- å…³å¡ç»“ç®— -->
Â  Â  <div id="result-modal" class="modal hidden">
Â  Â  Â  Â  <h1 id="result-title">LEVEL CLEARED</h1>
Â  Â  Â  Â  <p id="result-desc">Proceed to the next room.</p>
Â  Â  Â  Â  <button id="next-btn" class="btn" onclick="nextLevel()">CONTINUE</button>
Â  Â  </div>

Â  Â  <!-- å…³å¡åæ•…äº‹èƒŒæ™¯ï¼ˆæ¯å…³é€šå…³åæ˜¾ç¤ºï¼‰ -->
Â  Â  <div id="level-story-modal" class="modal hidden">
Â  Â  Â  Â  <div id="story-box">
Â  Â  Â  Â  Â  Â  <img id="story-bg-img" src="" alt="Story Background">
Â  Â  Â  Â  Â  Â  <div id="level-story-content" style="font-size: 16px; line-height: 1.8; margin-top: 20px;"></div>
Â  Â  Â  Â  Â  Â  <button class="btn" onclick="closeLevelStory()">ç»§ç»­</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

<script>
/**
Â * é…ç½®ä¸å¸¸é‡
Â */
const CANVAS = document.getElementById('gameCanvas');
const CTX = CANVAS.getContext('2d');
const MASK_CANVAS = document.createElement('canvas');
const MASK_CTX = MASK_CANVAS.getContext('2d');

// æ¸¸æˆå‚æ•°
const PLAYER_SIZE = 12;
const GHOST_SIZE = 15;
const P_SPEED = 4.5;
const G_SPEED = 1.9;
const GRID_SIZE = 40;

// çŠ¶æ€å˜é‡
let currentLang = 'CN'; // é»˜è®¤ä¸­æ–‡
let currentLevel = 1;
let gameRunning = false;
let isPaused = false;
let lives = 3;
let totalDots = 0;
let collectedDots = 0;
let frameId;
let musicPlaying = false;

// å®ä½“
let player = { x: 0, y: 0, dx: 0, dy: 0, invulnerable: 0 };
let ghosts = [];
let dots = [];
let bigStars = [];

// è¾“å…¥çŠ¶æ€
let keys = {};
let joystick = { active: false, dx: 0, dy: 0, originX: 0, originY: 0 };

/**
Â * å®Œæ•´çš„æ•…äº‹æ–‡æœ¬æ•°æ® - æ¯å…³é€šå…³åæ˜¾ç¤º
Â */
const TEXT_DATA = {
Â  Â  CN: {
Â  Â  Â  Â  ui_score: "æ”¶é›†åº¦",
Â  Â  Â  Â  ui_lives: "ç”Ÿå‘½",
Â  Â  Â  Â  level_cleared: "åŒºåŸŸè§£é”",
Â  Â  Â  Â  game_over: "æ„è¯†è¿·å¤±",
Â  Â  Â  Â  btn_continue: "è¿›å…¥ä¸‹ä¸€å±‚",
Â  Â  Â  Â  btn_retry: "é‡æ–°å°è¯•",
Â  Â  Â  Â  win_title: "è®°å¿†ä¿®å¤å®Œæˆ",
Â  Â  Â  Â  win_desc: "ä½ æŠšå¹³äº†è¿™åº§å»ºç­‘çš„æƒ…ç»ªã€‚åœ°ç†å­¦çš„ä¼ æ‰¿ï¼Œä»1922å»¶ç»­è‡³ä»Šã€‚",
Â  Â  Â  Â  
Â  Â  Â  Â  // å…³å¡å†…å‰§æƒ…
Â  Â  Â  Â  l1_intro: "ä½ å‡ºäºå¥½å¥‡æ¨å¼€äº†åœ°ç†å®¤çš„é—¨...è¿™é‡Œå˜å¾—ä¸ä¸€æ ·äº†ã€‚é‚£æ˜¯æ¢µé«˜çš„æ˜Ÿç©ºå—ï¼Ÿ",
Â  Â  Â  Â  l1_star1: "ã€2005å¹´çš„å›å“ã€‘\nè¿™æ ‹å»ºç­‘è½æˆäº2005å¹´ã€‚ä½ çœ‹é‚£é™¡å³­çš„å±‹é¡¶(Bumbung Curam)å’Œæ ‡å¿—æ€§çš„é€šé£å­”ï¼Œé‚£æ˜¯ä¸ºäº†é€‚åº”çƒ­å¸¦æ°”å€™è€Œä¿ç•™çš„æ®–æ°‘åœ°ç¾å­¦ã€‚",
Â  Â  Â  Â  
Â  Â  Â  Â  l2_intro: "æˆ¿é—´å˜å¾—æ›´ç ´æ—§äº†...åœ°ä¸Šå †æ»¡äº†æ—§æ—¶ä»£çš„æ•™å…·ã€‚",
Â  Â  Â  Â  l2_star1: "ã€1922å¹´çš„é—äº§ã€‘\nè¿™é‡Œç»§æ‰¿äº† SITC æ—¶ä»£çš„çµé­‚ã€‚åœ°ç†æ›¾æ˜¯è¿™é‡Œæœ€æ—©çš„æ ¸å¿ƒç§‘ç›®(Subjek Teras)ï¼Œæ•™å¯¼é©¬æ¥æ•™å¸ˆä»¬ç†è§£è„šä¸‹çš„åœŸåœ°ä¸ä¸–ç•Œã€‚",
Â  Â  Â  Â  
Â  Â  Â  Â  l3_intro: "ç©ºé—´å¼€å§‹æ‰­æ›²ï¼å¢™ä¸Šçš„æµ®é›•ä»¿ä½›æ´»äº†è¿‡æ¥ï¼å¿«é€ƒå‡ºå»ï¼",
Â  Â  Â  Â  l3_star1: "ã€æ¢ç´¢çš„æ¼”å˜ã€‘\nå¢™ä¸Šçš„æµ®é›•(Arca Timbul)è¯‰è¯´ç€äººç±»çš„æ¢ç´¢å²ã€‚ä»å¤è€çš„æ‰‹å·¥åˆ¶å›¾åˆ°ç°ä»£ GIS ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯¹ä¸–ç•Œçš„è®¤çŸ¥ä»æœªåœæ­¢ã€‚",
Â  Â  Â  Â  
Â  Â  Â  Â  // æ¯å…³é€šå…³åæ•…äº‹èƒŒæ™¯
Â  Â  Â  Â  level1_complete: "ã€ç¬¬ä¸€ç« ï¼šè‹é†’ã€‘\nä½ æ”¶é›†äº†è¿™ä¸ªåŒºåŸŸçš„æ‰€æœ‰è®°å¿†ç¢ç‰‡ã€‚å»ºç­‘åœ¨å›åº”ä½ ï¼Œå¢™å£ä¸Šçš„æ˜Ÿç©ºå¼€å§‹æµåŠ¨ï¼Œä»¿ä½›æœ‰ä»€ä¹ˆè¦è‹é†’è¿‡æ¥ã€‚",
Â  Â  Â  Â  level2_complete: "ã€ç¬¬äºŒç« ï¼šè¿½å¿†ã€‘\néšç€æ›´å¤šè®°å¿†è¢«ä¿®å¤ï¼Œå»ºç­‘çš„è¿‡å»é€æ¸æ¸…æ™°ã€‚1922å¹´çš„çµé­‚ä¸2005å¹´çš„æ–°ç”Ÿå‘½åœ¨æ­¤äº¤ç»‡ã€‚",
Â  Â  Â  Â  level3_complete: "ã€ç»ˆç« ï¼šä¼ æ‰¿ã€‘\næ‰€æœ‰çš„è®°å¿†éƒ½å·²æ”¶é›†å®Œæˆã€‚è¿™åº§å»ºç­‘çš„æƒ…ç»ªè¢«å½»åº•æŠšå¹³ï¼Œåœ°ç†å­¦çš„ä¼ æ‰¿å°†æ°¸è¿œå»¶ç»­ã€‚",
Â  Â  },
Â  Â  BM: {
Â  Â  Â  Â  ui_score: "KUTIPAN",
Â  Â  Â  Â  ui_lives: "NYAWA",
Â  Â  Â  Â  level_cleared: "ZON DIBUKA",
Â  Â  Â  Â  game_over: "TAMAT PERMAINAN",
Â  Â  Â  Â  btn_continue: "TERUSKAN",
Â  Â  Â  Â  btn_retry: "CUBA LAGI",
Â  Â  Â  Â  win_title: "MISI SELESAI",
Â  Â  Â  Â  win_desc: "Emosi bangunan telah dipulihkan. Legasi Geografi kekal dari 1922 hingga kini.",
Â  Â  Â  Â  
Â  Â  Â  Â  l1_intro: "Perasaan ingin tahu membawa anda ke sini... Adakah ini lukisan Van Gogh?",
Â  Â  Â  Â  l1_star1: "ã€Gema 2005ã€‘\nBangunan ini dirasmikan pada 2005. Lihat bumbung curam dan lubang pengudaraan itu, ia mengekalkan estetika kolonial untuk iklim tropika.",
Â  Â  Â  Â  
Â  Â  Â  Â  l2_intro: "Bilik ini kelihatan usang... Penuh dengan peralatan lama.",
Â  Â  Â  Â  l2_star1: "ã€Warisan 1922ã€‘\nDi sini terletaknya jiwa SITC. Geografi adalah antara subjek teras terawal, mengajar guru Melayu memahami tanah air dan dunia.",
Â  Â  Â  Â  
Â  Â  Â  Â  l3_intro: "Ruang semakin herot! Arca di dinding seakan hidup! Lari!",
Â  Â  Â  Â  l3_star1: "ã€Evolusi Eksplorasiã€‘\nArca timbul ini menceritakan sejarah eksplorasi. Dari peta manual ke sistem GIS moden, ilmu geografi terus berkembang.",
Â  Â  Â  Â  
Â  Â  Â  Â  level1_complete: "ã€Bab 1: Kebangkitanã€‘\nAnda mengumpulkan semua serpihan memori di kawasan ini. Bangunan itu menjawab, bintang di dinding mula mengalir, seolah-olah sesuatu akan bangkit.",
Â  Â  Â  Â  level2_complete: "ã€Bab 2: Kenanganã€‘\nDengan lebih banyak memori dipulihkan, masa lalu bangunan menjadi lebih jelas. Jiwa tahun 1922 dan nyawa baru tahun 2005 bersatu di sini.",
Â  Â  Â  Â  level3_complete: "ã€Bab Akhir: Warisanã€‘\nSemua memori telah dikumpulkan sepenuhnya. Emosi bangunan telah tenang sepenuhnya, warisan Geografi akan berterusan selamanya.",
Â  Â  },
Â  Â  EN: {
Â  Â  Â  Â  ui_score: "COLLECTED",
Â  Â  Â  Â  ui_lives: "LIVES",
Â  Â  Â  Â  level_cleared: "AREA CLEARED",
Â  Â  Â  Â  game_over: "GAME OVER",
Â  Â  Â  Â  btn_continue: "NEXT ROOM",
Â  Â  Â  Â  btn_retry: "TRY AGAIN",
Â  Â  Â  Â  win_title: "MEMORY RESTORED",
Â  Â  Â  Â  win_desc: "You have soothed the building's emotions. The legacy of Geography lives on.",
Â  Â  Â  Â  
Â  Â  Â  Â  l1_intro: "Curiosity led you inside... Is this a Van Gogh painting?",
Â  Â  Â  Â  l1_star1: "ã€Echoes of 2005ã€‘\nBuilt in 2005, this lab features steep roofs and iconic ventilation holes, preserving colonial aesthetics for the tropical climate.",
Â  Â  Â  Â  
Â  Â  Â  Â  l2_intro: "The room feels older... cluttered with vintage equipment.",
Â  Â  Â  Â  l2_star1: "ã€Legacy of 1922ã€‘\nThis site inherits the soul of SITC. Geography was a core subject, teaching Malay teachers to understand their land and geopolitics.",
Â  Â  Â  Â  
Â  Â  Â  Â  l3_intro: "Reality is twisting! The wall reliefs are moving! Run!",
Â  Â  Â  Â  l3_star1: "ã€Evolution of Explorationã€‘\nThe wall reliefs (Arca Timbul) tell the story of exploration. From manual mapping to modern GIS, our quest for knowledge never ends.",
Â  Â  Â  Â  
Â  Â  Â  Â  level1_complete: "ã€Chapter 1: Awakeningã€‘\nYou collected all memory fragments in this area. The building responds, stars on walls begin to flow as if something is awakening.",
Â  Â  Â  Â  level2_complete: "ã€Chapter 2: Remembranceã€‘\nWith more memories restored, the building's past becomes clearer. The soul of 1922 and new life of 2005 intertwine here.",
Â  Â  Â  Â  level3_complete: "ã€Final Chapter: Legacyã€‘\nAll memories have been collected. The building's emotions are completely soothed, the legacy of Geography will continue forever.",
Â  Â  }
};

/**
Â * èµ„æºç®¡ç†ä¸åˆå§‹åŒ–
Â */
const bgImg = new Image();
const maskImg = new Image();
const levelStoryImgs = []; // å…³å¡æ•…äº‹èƒŒæ™¯å›¾ç‰‡

// é¢„åŠ è½½å…³å¡æ•…äº‹èƒŒæ™¯å›¾
for(let i=0; i<3; i++) {
Â  Â  const img = new Image();
Â  Â  img.src = `story_bg${i+1}.jpg`;
Â  Â  img.onerror = () => {
Â  Â  Â  Â  console.error(`Failed to load story_bg${i+1}.jpg`);
Â  Â  Â  Â  img.loaded = false;
Â  Â  };
Â  Â  img.onload = () => {
Â  Â  Â  Â  img.loaded = true;
Â  Â  Â  Â  console.log(`Loaded story_bg${i+1}.jpg`);
Â  Â  };
Â  Â  levelStoryImgs.push(img);
}

function toggleMusic() {
Â  Â  const audio = document.getElementById('bgMusic');
Â  Â  const btn = document.getElementById('music-btn');
Â  Â  if (!audio) return;
Â  Â  
Â  Â  if (musicPlaying) {
Â  Â  Â  Â  audio.pause();
Â  Â  Â  Â  btn.textContent = 'ğŸ”‡';
Â  Â  } else {
Â  Â  Â  Â  audio.play().catch(e => {
Â  Â  Â  Â  Â  Â  console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥:', e);
Â  Â  Â  Â  Â  Â  alert('éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥bgm.mp3æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
Â  Â  Â  Â  });
Â  Â  Â  Â  btn.textContent = 'ğŸµ';
Â  Â  }
Â  Â  musicPlaying = !musicPlaying;
}

function selectLang(lang) {
Â  Â  currentLang = lang;
Â  Â  document.getElementById('start-screen').classList.add('hidden');
Â  Â  initLevel(1);
}

function initLevel(lvl) {
Â  Â  currentLevel = lvl;
Â  Â  isPaused = true;
Â  Â  gameRunning = false;
Â  Â  
Â  Â  bgImg.src = `bg_level${lvl}.jpg`;
Â  Â  maskImg.src = `mask_level${lvl}.jpg`;
Â  Â  
Â  Â  let loaded = 0;
Â  Â  const checkLoad = () => {
Â  Â  Â  Â  loaded++;
Â  Â  Â  Â  if(loaded === 2) setupGameWorld();
Â  Â  };
Â  Â  bgImg.onload = checkLoad;
Â  Â  maskImg.onload = checkLoad;
Â  Â  bgImg.onerror = () => { 
Â  Â  Â  Â  console.error(`Missing bg_level${lvl}.jpg`); 
Â  Â  Â  Â  checkLoad(); 
Â  Â  };
Â  Â  maskImg.onerror = () => { 
Â  Â  Â  Â  console.error(`Missing mask_level${lvl}.jpg`); 
Â  Â  Â  Â  checkLoad(); 
Â  Â  };
}

function setupGameWorld() {
Â  Â  CANVAS.width = MASK_CANVAS.width = bgImg.naturalWidth;
Â  Â  CANVAS.height = MASK_CANVAS.height = bgImg.naturalHeight;
Â  Â  MASK_CTX.drawImage(maskImg, 0, 0);
Â  Â  CTX.imageSmoothingEnabled = false;

Â  Â  let startPos = findSafeSpot(100, CANVAS.height/2, PLAYER_SIZE);
Â  Â  player.x = startPos.x;
Â  Â  player.y = startPos.y;
Â  Â  player.invulnerable = 0;

Â  Â  ghosts = [];
Â  Â  let ghostCount = currentLevel;
Â  Â  for(let i=0; i<ghostCount; i++) {
Â  Â  Â  Â  let gPos = findSafeSpot(CANVAS.width - 200, 200 + i*150, GHOST_SIZE);
Â  Â  Â  Â  ghosts.push({ x: gPos.x, y: gPos.y, angle: Math.PI, color: '#000' });
Â  Â  }

Â  Â  generateDotsAndStars();

Â  Â  showStory(getText(`l${currentLevel}_intro`));
Â  Â  
Â  Â  gameRunning = true;
Â  Â  isPaused = true;
Â  Â  updateHUD();
Â  Â  requestAnimationFrame(gameLoop);
}

function generateDotsAndStars() {
Â  Â  dots = [];
Â  Â  bigStars = [];
Â  Â  let w = CANVAS.width;
Â  Â  let h = CANVAS.height;

Â  Â  for(let y = 50; y < h - 50; y += GRID_SIZE) {
Â  Â  Â  Â  for(let x = 50; x < w - 50; x += GRID_SIZE) {
Â  Â  Â  Â  Â  Â  if(!checkCollision(x, y, 5)) {
Â  Â  Â  Â  Â  Â  Â  Â  dots.push({ x: x, y: y, active: true });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  Â  totalDots = dots.length;
Â  Â  collectedDots = 0;

Â  Â  let mid = findSafeSpot(w/2, h/2, 20);
Â  Â  bigStars.push({ x: mid.x, y: mid.y, textKey: `l${currentLevel}_star1`, active: true, size: 14 });
}

function update() {
Â  Â  if(!gameRunning || isPaused) return;

Â  Â  let dx = 0, dy = 0;
Â  Â  
Â  Â  if (keys['ArrowUp']) dy -= 1;
Â  Â  if (keys['ArrowDown']) dy += 1;
Â  Â  if (keys['ArrowLeft']) dx -= 1;
Â  Â  if (keys['ArrowRight']) dx += 1;
Â  Â  
Â  Â  if (joystick.active) {
Â  Â  Â  Â  dx = joystick.dx;
Â  Â  Â  Â  dy = joystick.dy;
Â  Â  }

Â  Â  if (dx !== 0 || dy !== 0) {
Â  Â  Â  Â  let len = Math.hypot(dx, dy);
Â  Â  Â  Â  if (len > 0.1) {
Â  Â  Â  Â  Â  Â  dx = (dx / len) * P_SPEED;
Â  Â  Â  Â  Â  Â  dy = (dy / len) * P_SPEED;
Â  Â  Â  Â  Â  Â  moveWithPhysics(player, dx, dy, PLAYER_SIZE);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  ghosts.forEach(g => {
Â  Â  Â  Â  let tx = player.x - g.x;
Â  Â  Â  Â  let ty = player.y - g.y;
Â  Â  Â  Â  let dist = Math.hypot(tx, ty);
Â  Â  Â  Â  let targetAngle = Math.atan2(ty, tx);

Â  Â  Â  Â  let bestAngle = g.angle;
Â  Â  Â  Â  let foundPath = false;
Â  Â  Â  Â  let scanAngles = [0, -0.4, 0.4, -0.8, 0.8, -1.5, 1.5];

Â  Â  Â  Â  for (let a of scanAngles) {
Â  Â  Â  Â  Â  Â  let tryA = targetAngle + a;
Â  Â  Â  Â  Â  Â  let lookAhead = G_SPEED * 15;
Â  Â  Â  Â  Â  Â  let px = g.x + Math.cos(tryA) * lookAhead;
Â  Â  Â  Â  Â  Â  let py = g.y + Math.sin(tryA) * lookAhead;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!checkCollision(px, py, GHOST_SIZE)) {
Â  Â  Â  Â  Â  Â  Â  Â  bestAngle = tryA;
Â  Â  Â  Â  Â  Â  Â  Â  foundPath = true;
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (!foundPath) bestAngle += 2.5;

Â  Â  Â  Â  let diff = bestAngle - g.angle;
Â  Â  Â  Â  while(diff > Math.PI) diff -= Math.PI*2;
Â  Â  Â  Â  while(diff < -Math.PI) diff += Math.PI*2;
Â  Â  Â  Â  g.angle += diff * 0.15;

Â  Â  Â  Â  moveWithPhysics(g, Math.cos(g.angle)*G_SPEED, Math.sin(g.angle)*G_SPEED, GHOST_SIZE);

Â  Â  Â  Â  if (dist < PLAYER_SIZE + GHOST_SIZE && player.invulnerable <= 0) {
Â  Â  Â  Â  Â  Â  playerHit();
Â  Â  Â  Â  }
Â  Â  });

Â  Â  if (player.invulnerable > 0) player.invulnerable--;

Â  Â  dots.forEach(d => {
Â  Â  Â  Â  if (d.active && Math.hypot(player.x - d.x, player.y - d.y) < PLAYER_SIZE + 5) {
Â  Â  Â  Â  Â  Â  d.active = false;
Â  Â  Â  Â  Â  Â  collectedDots++;
Â  Â  Â  Â  Â  Â  updateHUD();
Â  Â  Â  Â  }
Â  Â  });

Â  Â  bigStars.forEach(s => {
Â  Â  Â  Â  if (s.active && Math.hypot(player.x - s.x, player.y - s.y) < PLAYER_SIZE + 10) {
Â  Â  Â  Â  Â  Â  s.active = false;
Â  Â  Â  Â  Â  Â  let text = getText(s.textKey);
Â  Â  Â  Â  Â  Â  showStory(text);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  let progress = collectedDots / totalDots;
Â  Â  // ä¿®æ”¹ï¼šå¿…é¡»æ”¶é›†100%æ‰èƒ½é€šå…³
Â  Â  if (progress >= 1.0 && player.x > CANVAS.width - 150) {
Â  Â  Â  Â  levelWin();
Â  Â  }
}

function draw() {
Â  Â  CTX.clearRect(0, 0, CANVAS.width, CANVAS.height);
Â  Â  CTX.drawImage(bgImg, 0, 0);

Â  Â  CTX.fillStyle = "#f9d71c";
Â  Â  dots.forEach(d => {
Â  Â  Â  Â  if(d.active) CTX.fillRect(d.x - 3, d.y - 3, 6, 6);
Â  Â  });

Â  Â  CTX.fillStyle = "#fff";
Â  Â  CTX.shadowBlur = 10; CTX.shadowColor = "#f9d71c";
Â  Â  bigStars.forEach(s => {
Â  Â  Â  Â  if(s.active) {
Â  Â  Â  Â  Â  Â  CTX.beginPath(); CTX.arc(s.x, s.y, s.size || 14, 0, Math.PI*2); CTX.fill();
Â  Â  Â  Â  }
Â  Â  });
Â  Â  CTX.shadowBlur = 0;

Â  Â  if (Math.floor(player.invulnerable / 5) % 2 === 0) {
Â  Â  Â  Â  CTX.fillStyle = "#0ff";
Â  Â  Â  Â  CTX.fillRect(player.x - PLAYER_SIZE, player.y - PLAYER_SIZE, PLAYER_SIZE*2, PLAYER_SIZE*2);
Â  Â  Â  Â  CTX.fillStyle = "#000";
Â  Â  Â  Â  CTX.fillRect(player.x - 5, player.y - 4, 3, 3);
Â  Â  Â  Â  CTX.fillRect(player.x + 2, player.y - 4, 3, 3);
Â  Â  }

Â  Â  ghosts.forEach(g => {
Â  Â  Â  Â  CTX.save();
Â  Â  Â  Â  CTX.translate(g.x, g.y);
Â  Â  Â  Â  CTX.rotate(g.angle);
Â  Â  Â  Â  CTX.fillStyle = "#000";
Â  Â  Â  Â  CTX.beginPath(); CTX.arc(0, 0, GHOST_SIZE, 0, Math.PI*2); CTX.fill();
Â  Â  Â  Â  CTX.strokeStyle = "#f00"; CTX.lineWidth = 2;
Â  Â  Â  Â  CTX.beginPath(); CTX.moveTo(0,0); CTX.lineTo(10,0); CTX.stroke();
Â  Â  Â  Â  CTX.restore();
Â  Â  });
}

function isWall(x, y) {
Â  Â  if (x < 0 || x >= MASK_CANVAS.width || y < 0 || y >= MASK_CANVAS.height) return true;
Â  Â  return MASK_CTX.getImageData(Math.floor(x), Math.floor(y), 1, 1).data[0] < 120;
}

function checkCollision(x, y, size) {
Â  Â  let r = size - 1;
Â  Â  return isWall(x, y) || 
Â  Â  Â  Â  Â  Â isWall(x+r, y) || isWall(x-r, y) || 
Â  Â  Â  Â  Â  Â isWall(x, y+r) || isWall(x, y-r) ||
Â  Â  Â  Â  Â  Â isWall(x+r, y+r) || isWall(x-r, y-r);
}

function moveWithPhysics(entity, dx, dy, size) {
Â  Â  const steps = 4; 
Â  Â  let sx = dx / steps;
Â  Â  let sy = dy / steps;
Â  Â  for(let i=0; i<steps; i++) {
Â  Â  Â  Â  if(!checkCollision(entity.x + sx, entity.y, size)) entity.x += sx;
Â  Â  Â  Â  if(!checkCollision(entity.x, entity.y + sy, size)) entity.y += sy;
Â  Â  }
}

function findSafeSpot(sx, sy, size) {
Â  Â  let r = 0;
Â  Â  while(r < 500) {
Â  Â  Â  Â  for(let dx = -r; dx <= r; dx += 20) {
Â  Â  Â  Â  Â  Â  for(let dy = -r; dy <= r; dy += 20) {
Â  Â  Â  Â  Â  Â  Â  Â  if(!checkCollision(sx+dx, sy+dy, size)) return {x: sx+dx, y: sy+dy};
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  r += 50;
Â  Â  }
Â  Â  return {x: sx, y: sy};
}

function playerHit() {
Â  Â  lives--;
Â  Â  updateHUD();
Â  Â  if (lives <= 0) {
Â  Â  Â  Â  showResult(getText('game_over'), getText('btn_retry'), () => location.reload());
Â  Â  } else {
Â  Â  Â  Â  player.invulnerable = 120;
Â  Â  Â  Â  let safe = findSafeSpot(100, CANVAS.height/2, PLAYER_SIZE);
Â  Â  Â  Â  player.x = safe.x; player.y = safe.y;
Â  Â  Â  Â  ghosts.forEach(g => g.x += 200); 
Â  Â  Â  Â  alert("OUCH! Carefull...");
Â  Â  }
}

// ä¿®æ”¹ï¼šæ¯å…³é€šå…³åæ˜¾ç¤ºå¯¹åº”æ•…äº‹èƒŒæ™¯
function levelWin() {
Â  Â  isPaused = true;
Â  Â  gameRunning = false;
Â  Â  
Â  Â  // å…ˆéšè—ç»“ç®—ç•Œé¢
Â  Â  document.getElementById('result-modal').classList.add('hidden');
Â  Â  
Â  Â  // æ˜¾ç¤ºå½“å‰å…³å¡çš„æ•…äº‹èƒŒæ™¯
Â  Â  showLevelStory(currentLevel);
}

// æ˜¾ç¤ºå…³å¡æ•…äº‹èƒŒæ™¯ï¼ˆstory_bg1, story_bg2, story_bg3ï¼‰
function showLevelStory(level) {
Â  Â  const modal = document.getElementById('level-story-modal');
Â  Â  const img = document.getElementById('story-bg-img');
Â  Â  const content = document.getElementById('level-story-content');
Â  Â  
Â  Â  // åŠ è½½å¯¹åº”å…³å¡çš„èƒŒæ™¯å›¾
Â  Â  const storyIndex = level - 1; // å…³å¡1å¯¹åº”story_bg1
Â  Â  if (levelStoryImgs[storyIndex] && levelStoryImgs[storyIndex].loaded) {
Â  Â  Â  Â  img.src = levelStoryImgs[storyIndex].src;
Â  Â  Â  Â  img.style.display = 'block';
Â  Â  } else {
Â  Â  Â  Â  img.style.display = 'none';
Â  Â  Â  Â  console.warn(`story_bg${level}.jpg not loaded`);
Â  Â  }
Â  Â  
Â  Â  // æ˜¾ç¤ºå¯¹åº”æ–‡æœ¬
Â  Â  content.textContent = getText(`level${level}_complete`);
Â  Â  modal.classList.remove('hidden');
}

// å…³é—­å…³å¡æ•…äº‹ï¼Œè¿›å…¥ä¸‹ä¸€å…³æˆ–ç»“æŸæ¸¸æˆ
function closeLevelStory() {
Â  Â  document.getElementById('level-story-modal').classList.add('hidden');
Â  Â  
Â  Â  if (currentLevel < 3) {
Â  Â  Â  Â  // è¿›å…¥ä¸‹ä¸€å…³
Â  Â  Â  Â  initLevel(currentLevel + 1);
Â  Â  } else {
Â  Â  Â  Â  // å…¨éƒ¨é€šå…³ï¼Œæ˜¾ç¤ºæœ€ç»ˆèƒœåˆ©ç”»é¢
Â  Â  Â  Â  showResult(getText('win_title'), getText('btn_retry'), () => location.reload());
Â  Â  }
}

function showStory(text) {
Â  Â  isPaused = true;
Â  Â  document.getElementById('story-content').innerText = text;
Â  Â  document.getElementById('story-modal').classList.remove('hidden');
}

function closeStory() {
Â  Â  document.getElementById('story-modal').classList.add('hidden');
Â  Â  isPaused = false;
}

function showResult(title, btnText, callback) {
Â  Â  document.getElementById('result-title').innerText = title;
Â  Â  document.getElementById('result-desc').innerText = "";
Â  Â  let btn = document.getElementById('next-btn');
Â  Â  btn.innerText = btnText;
Â  Â  btn.onclick = callback;
Â  Â  document.getElementById('result-modal').classList.remove('hidden');
}

function getText(key) {
Â  Â  return TEXT_DATA[currentLang][key] || key;
}

function updateHUD() {
Â  Â  let hearts = "";
Â  Â  for(let i=0; i<lives; i++) hearts += "â¤ï¸";
Â  Â  document.getElementById('lives').innerHTML = hearts;
Â  Â  
Â  Â  let pct = Math.floor((collectedDots / totalDots) * 100);
Â  Â  document.getElementById('collect-text').innerText = isNaN(pct) ? "0%" : pct + "%";
Â  Â  document.getElementById('level-num').innerText = currentLevel;
}

window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

const joyZone = document.getElementById('joystick-zone');
const joyKnob = document.getElementById('joystick-knob');

joyZone.addEventListener('touchstart', e => {
Â  Â  e.preventDefault();
Â  Â  let touch = e.touches[0];
Â  Â  let rect = joyZone.getBoundingClientRect();
Â  Â  joystick.active = true;
Â  Â  joystick.originX = rect.left + rect.width/2;
Â  Â  joystick.originY = rect.top + rect.height/2;
Â  Â  updateJoystick(touch.clientX, touch.clientY);
}, {passive: false});

joyZone.addEventListener('touchmove', e => {
Â  Â  e.preventDefault();
Â  Â  if(joystick.active) updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
}, {passive: false});

const endJoy = e => {
Â  Â  e.preventDefault();
Â  Â  joystick.active = false;
Â  Â  joystick.dx = 0; joystick.dy = 0;
Â  Â  joyKnob.style.transform = `translate(-50%, -50%)`;
};
joyZone.addEventListener('touchend', endJoy);
joyZone.addEventListener('touchcancel', endJoy);

function updateJoystick(x, y) {
Â  Â  let maxDist = 40;
Â  Â  let dx = x - joystick.originX;
Â  Â  let dy = y - joystick.originY;
Â  Â  let dist = Math.hypot(dx, dy);
Â  Â  
Â  Â  if(dist > maxDist) {
Â  Â  Â  Â  dx = (dx/dist) * maxDist;
Â  Â  Â  Â  dy = (dy/dist) * maxDist;
Â  Â  }
Â  Â  joystick.dx = dx / maxDist;
Â  Â  joystick.dy = dy / maxDist;
Â  Â  
Â  Â  joyKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
}

function gameLoop() {
Â  Â  update();
Â  Â  draw();
Â  Â  frameId = requestAnimationFrame(gameLoop);
}

</script>
</body>
</html>
