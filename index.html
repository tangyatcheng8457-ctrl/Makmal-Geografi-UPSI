<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Starry Echoes: The Geographer's Maze</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; touch-action: none; user-select: none; }
        
        canvas { 
            display: block; width: 100vw; height: 100vh; object-fit: contain;
            image-rendering: pixelated; 
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .hud { position: absolute; color: #fff; text-shadow: 2px 2px 0 #000; font-weight: bold; pointer-events: none; }
        #lives { top: 20px; left: 20px; font-size: 30px; }
        #score-board { top: 20px; right: 20px; font-size: 24px; text-align: right; }
        
        #joystick-zone { position: absolute; bottom: 50px; left: 50px; width: 150px; height: 150px; pointer-events: auto; z-index: 50; }
        #joystick-knob { position: absolute; width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 10px #fff; pointer-events: none; }
        #joystick-base { width: 100%; height: 100%; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; background: rgba(0,0,0,0.2); }

        .modal { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 100; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: #fff; text-align: center; padding: 20px; box-sizing: border-box;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 40px; margin-bottom: 10px; color: #f9d71c; }
        p { font-size: 18px; line-height: 1.6; max-width: 600px; margin: 0 auto 20px auto; }
        
        .btn { 
            background: #2b5fa3; color: #fff; border: 2px solid #f9d71c; 
            padding: 15px 40px; font-size: 20px; cursor: pointer; margin: 10px; 
            border-radius: 10px; font-family: inherit; transition: 0.2s;
        }
        .btn:active { transform: scale(0.95); }

        #story-box { 
            background: rgba(0, 20, 40, 0.9); border: 4px solid #f9d71c; 
            border-radius: 15px; padding: 30px; max-width: 80%;
        }
        #story-title { color: #f9d71c; font-size: 24px; margin-bottom: 15px; }
        #story-content { font-size: 18px; text-align: left; min-height: 100px; }

        #start-screen {
            background-image: url('bg_start.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        #music-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid #f9d71c;
            color: #f9d71c;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 200;
            font-size: 24px;
        }
        
        #story-bg-img {
            width: 90%;
            max-width: 800px;
            height: 60vh;
            object-fit: contain;
            margin: 20px auto;
            border: 3px solid #f9d71c;
            border-radius: 10px;
        }
        
        #level-story-content {
            font-size: 20px;
            line-height: 1.8;
            margin-top: 20px;
            max-width: 90%;
            max-height: 30vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <audio id="bgMusic" loop>
        <source src="bgm.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    
    <div id="music-btn" onclick="toggleMusic()">üéµ</div>

    <div id="ui-layer">
        <div id="lives" class="hud">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div id="score-board" class="hud">
            LV <span id="level-num">1</span><br>
            <span id="collect-text">0%</span>
        </div>
        <div id="joystick-zone">
            <div id="joystick-base"></div>
            <div id="joystick-knob"></div>
        </div>
    </div>

    <div id="start-screen" class="modal">
        <h1 style="font-family: serif; font-style: italic;">Starry Echoes</h1>
        <p style="color: #aaa;">The Geographer's Maze</p>
        <div style="margin-top: 40px;">
            <button class="btn lang-btn" onclick="selectLang('CN')">‰∏≠Êñá</button>
            <button class="btn lang-btn" onclick="selectLang('BM')">Melayu</button>
            <button class="btn lang-btn" onclick="selectLang('EN')">English</button>
        </div>
    </div>

    <div id="story-modal" class="modal hidden">
        <div id="story-box">
            <div id="story-title">HISTORY FOUND</div>
            <div id="story-content">...</div>
            <button class="btn" onclick="closeStory()">‚ñº</button>
        </div>
    </div>

    <div id="result-modal" class="modal hidden">
        <h1 id="result-title">LEVEL CLEARED</h1>
        <p id="result-desc">Proceed to the next room.</p>
        <button id="next-btn" class="btn" onclick="nextLevel()">CONTINUE</button>
    </div>

    <div id="level-story-modal" class="modal hidden">
        <div id="story-box">
            <img id="story-bg-img" src="" alt="Story Background">
            <div id="level-story-content"></div>
            <button class="btn" onclick="closeLevelStory()"><span id="story-btn-text">ÁªßÁª≠</span></button>
        </div>
    </div>

<script>
/**
 * ÈÖçÁΩÆ‰∏éÂ∏∏Èáè
 */
const CANVAS = document.getElementById('gameCanvas');
const CTX = CANVAS.getContext('2d');
const MASK_CANVAS = document.createElement('canvas');
const MASK_CTX = MASK_CANVAS.getContext('2d');

// Ê∏∏ÊàèÂèÇÊï∞ - ÊîæÂ§ßÊâÄÊúâÂÖÉÁ¥†
const PLAYER_SIZE = 24; // ‰ªé18Â¢ûÂä†Âà∞24ÔºàÊõ¥Â§ßÔºâ
const GHOST_SIZE = 30;  // ‰ªé22Â¢ûÂä†Âà∞30ÔºàÊõ¥Â§ßÔºâ
const P_SPEED = 2.5;    
const G_SPEED = 1.0;    
const GRID_SIZE = 60;   

// Áä∂ÊÄÅÂèòÈáè
let currentLang = 'CN';
let currentLevel = 1;
let gameRunning = false;
let isPaused = false;
let lives = 3;
let totalDots = 0;
let collectedDots = 0;
let frameId;
let musicPlaying = false;
let animationFrame = 0;

// ÂÆû‰Ωì
let player = { x: 0, y: 0, dx: 0, dy: 0, invulnerable: 0, angle: 0 };
let ghosts = [];
let dots = [];
let bigStars = [];

// ËæìÂÖ•Áä∂ÊÄÅ
let keys = {};
let joystick = { active: false, dx: 0, dy: 0, originX: 0, originY: 0 };

/**
 * ÂÆåÊï¥ÁöÑÊïÖ‰∫ãÊñáÊú¨Êï∞ÊçÆ
 */
const TEXT_DATA = {
    CN: {
        ui_score: "Êî∂ÈõÜÂ∫¶",
        ui_lives: "ÁîüÂëΩ",
        level_cleared: "Âå∫ÂüüËß£ÈîÅ",
        game_over: "ÊÑèËØÜËø∑Â§±",
        btn_continue: "ËøõÂÖ•‰∏ã‰∏ÄÂ±Ç",
        btn_retry: "ÈáçÊñ∞Â∞ùËØï",
        win_title: "ËÆ∞ÂøÜ‰øÆÂ§çÂÆåÊàê",
        win_desc: "‰Ω†ÊäöÂπ≥‰∫ÜËøôÂ∫ßÂª∫Á≠ëÁöÑÊÉÖÁª™„ÄÇÂú∞ÁêÜÂ≠¶ÁöÑ‰º†ÊâøÔºå‰ªé1922Âª∂Áª≠Ëá≥‰ªä„ÄÇ",
        next_btn: "ÁªßÁª≠",
        
        l1_intro: "‰Ω†Âá∫‰∫éÂ•ΩÂ•áÊé®ÂºÄ‰∫ÜÂú∞ÁêÜÂÆ§ÁöÑÈó®...ËøôÈáåÂèòÂæó‰∏ç‰∏ÄÊ†∑‰∫Ü„ÄÇÈÇ£ÊòØÊ¢µÈ´òÁöÑÊòüÁ©∫ÂêóÔºü",
        l1_star1: "„Äê2005Âπ¥ÁöÑÂõûÂìç„Äë\nËøôÊ†ãÂª∫Á≠ëËêΩÊàê‰∫é2005Âπ¥„ÄÇ‰Ω†ÁúãÈÇ£Èô°Â≥≠ÁöÑÂ±ãÈ°∂(Bumbung Curam)ÂíåÊ†áÂøóÊÄßÁöÑÈÄöÈ£éÂ≠îÔºåÈÇ£ÊòØ‰∏∫‰∫ÜÈÄÇÂ∫îÁÉ≠Â∏¶Ê∞îÂÄôËÄå‰øùÁïôÁöÑÊÆñÊ∞ëÂú∞ÁæéÂ≠¶„ÄÇ",
        
        l2_intro: "ÊàøÈó¥ÂèòÂæóÊõ¥Á†¥Êóß‰∫Ü...Âú∞‰∏äÂ†ÜÊª°‰∫ÜÊóßÊó∂‰ª£ÁöÑÊïôÂÖ∑„ÄÇ",
        l2_star1: "„Äê1922Âπ¥ÁöÑÈÅó‰∫ß„Äë\nËøôÈáåÁªßÊâø‰∫Ü SITC Êó∂‰ª£ÁöÑÁÅµÈ≠Ç„ÄÇÂú∞ÁêÜÊõæÊòØËøôÈáåÊúÄÊó©ÁöÑÊ†∏ÂøÉÁßëÁõÆ(Subjek Teras)ÔºåÊïôÂØºÈ©¨Êù•ÊïôÂ∏à‰ª¨ÁêÜËß£ËÑö‰∏ãÁöÑÂúüÂú∞‰∏é‰∏ñÁïå„ÄÇ",
        
        l3_intro: "Á©∫Èó¥ÂºÄÂßãÊâ≠Êõ≤ÔºÅÂ¢ô‰∏äÁöÑÊµÆÈõï‰ªø‰ΩõÊ¥ª‰∫ÜËøáÊù•ÔºÅÂø´ÈÄÉÂá∫ÂéªÔºÅ",
        l3_star1: "„ÄêÊé¢Á¥¢ÁöÑÊºîÂèò„Äë\nÂ¢ô‰∏äÁöÑÊµÆÈõï(Arca Timbul)ËØâËØ¥ÁùÄ‰∫∫Á±ªÁöÑÊé¢Á¥¢Âè≤„ÄÇ‰ªéÂè§ËÄÅÁöÑÊâãÂ∑•Âà∂ÂõæÂà∞Áé∞‰ª£ GIS Á≥ªÁªüÔºåÊàë‰ª¨ÂØπ‰∏ñÁïåÁöÑËÆ§Áü•‰ªéÊú™ÂÅúÊ≠¢„ÄÇ",
        
        level1_complete: "„ÄêÁ¨¨‰∏ÄÁ´†ÔºöËãèÈÜí„Äë\n‰Ω†Êî∂ÈõÜ‰∫ÜËøô‰∏™Âå∫ÂüüÁöÑÊâÄÊúâËÆ∞ÂøÜÁ¢éÁâá„ÄÇÂª∫Á≠ëÂú®ÂõûÂ∫î‰Ω†ÔºåÂ¢ôÂ£Å‰∏äÁöÑÊòüÁ©∫ÂºÄÂßãÊµÅÂä®Ôºå‰ªø‰ΩõÊúâ‰ªÄ‰πàË¶ÅËãèÈÜíËøáÊù•„ÄÇ\n\n" +
                         "ËøôÂ∫ßÂú∞ÁêÜÂÆûÈ™åÂÆ§ÊòØ‰∫∫ÊñáÂ≠¶Èô¢‰∏ãÁöÑÂçìË∂ä‰∏≠ÂøÉÔºå‰∫é2005Âπ¥ËêΩÊàêÔºåÂª∂Áª≠‰∫ÜËá™1922Âπ¥SITCÊó∂‰ª£ÂºÄÂßãÁöÑÂú∞ÁêÜÂ≠¶‰º†Êâø„ÄÇÂú∞ÁêÜÂ≠¶Âú®‰∏πÁªíÈ©¨ÊûóÊúâÁùÄÈùûÂ∏∏ÈáçË¶ÅÁöÑÂéÜÂè≤ÊÑè‰πâÔºåÂõ†‰∏∫ÂÆÉÊòØÊúÄÊó©ÊïôÊéàÁªôÈ©¨Êù•ÊïôÂ∏àÁöÑÊ†∏ÂøÉÁßëÁõÆ‰πã‰∏ÄÔºåËÆ©‰ªñ‰ª¨ÁêÜËß£Âú∞ÂõæÁªòÂà∂„ÄÅËá™ÁÑ∂ËµÑÊ∫êÂíåÂõΩÂÆ∂Âú∞ÁºòÊîøÊ≤ª„ÄÇ",
        
        level2_complete: "„ÄêÁ¨¨‰∫åÁ´†ÔºöËøΩÂøÜ„Äë\nÈöèÁùÄÊõ¥Â§öËÆ∞ÂøÜË¢´‰øÆÂ§çÔºåÂª∫Á≠ëÁöÑËøáÂéªÈÄêÊ∏êÊ∏ÖÊô∞„ÄÇ1922Âπ¥ÁöÑÁÅµÈ≠Ç‰∏é2005Âπ¥ÁöÑÊñ∞ÁîüÂëΩÂú®Ê≠§‰∫§Áªá„ÄÇ\n\n" +
                         "‰ªéËÆæËÆ°ËßíÂ∫¶Êù•ÁúãÔºåËøôÂ∫ßÂª∫Á≠ë‰øùÁïô‰∫ÜÊÆñÊ∞ëÁæéÂ≠¶ÔºåÈÄöËøáÈô°Â≥≠ÁöÑÂ±ãÈ°∂ÁªìÊûÑÂíåÊ†áÂøóÊÄßÁöÑÈÄöÈ£éÂ≠îÔºåÂêåÊó∂Âú®Â§ñÂ¢ôÂä†Âº∫‰∫ÜÁã¨ÁâπÁöÑÊµÆÈõïÔºåÂ±ïÁ§∫‰∏ñÁïåÂú∞Âõæ‰Ωú‰∏∫‰∫∫Á±ªÊé¢Á¥¢ÂéÜÂè≤ÁöÑË±°ÂæÅ„ÄÇËøôÁßçÊï¥ÂêàË±°ÂæÅÁùÄÁü•ËØÜ‰ªé‰º†ÁªüÊâãÂ∑•Âà∂ÂõæÊñπÊ≥ïÂêëÁé∞‰ª£Âú∞ÁêÜ‰ø°ÊÅØÁ≥ªÁªüÔºàGISÔºâÊäÄÊúØÁöÑËΩ¨Âèò„ÄÇ",
        
        level3_complete: "„ÄêÁªàÁ´†Ôºö‰º†Êâø„Äë\nÊâÄÊúâÁöÑËÆ∞ÂøÜÈÉΩÂ∑≤Êî∂ÈõÜÂÆåÊàê„ÄÇËøôÂ∫ßÂª∫Á≠ëÁöÑÊÉÖÁª™Ë¢´ÂΩªÂ∫ïÊäöÂπ≥ÔºåÂú∞ÁêÜÂ≠¶ÁöÑ‰º†ÊâøÂ∞ÜÊ∞∏ËøúÂª∂Áª≠„ÄÇ\n\n" +
                         "ËøôÂ∫ßÂª∫Á≠ëÁöÑÂ≠òÂú®Âî§Ëµ∑‰∫ÜÂØπÁü•ËØÜËøûÁª≠ÊÄßÁöÑÊï¨ÁïèÔºåËøôÁßçËøûÁª≠ÊÄßÊèêÂçáÂõΩÂÆ∂Âú∞ÁêÜÊïôËÇ≤Â∑≤Ë∂ÖËøá‰∏Ä‰∏™‰∏ñÁ∫™„ÄÇÂÆÉÂÇ≤ÁÑ∂ÁüóÁ´ãÔºåË±°ÂæÅÁùÄÂ∞ÜÂâçËæàÊïôËÇ≤Â∑•‰ΩúËÄÖÁöÑÂ•ãÊñóÊÄÄÊóß‰∏é‰ªäÂ§©Â≠¶ÁîüÁöÑÂ≠¶ÊúØÊä±Ë¥üÂõ¢ÁªìÂú®‰∏ÄËµ∑ÁöÑÈ™ÑÂÇ≤„ÄÇÂØπËøôÁßçÂéÜÂè≤ÈÅó‰∫ßÁöÑÁÉ≠Áà±Â¢ûÂº∫‰∫ÜÊàë‰ª¨ÁªßÁª≠‰øùÊä§Âú∞ÁêÉÂèØÊåÅÁª≠ÊÄßÂπ∂ÊèêÂçáÂú∞ÁêÜÂ≠¶Áü•ËØÜÁöÑÂÜ≥ÂøÉÔºå‰∏∫‰∫ÜÊú™Êù•ÁöÑ‰∏Ä‰ª£„ÄÇ",
    },
    BM: {
        ui_score: "KUTIPAN",
        ui_lives: "NYAWA",
        level_cleared: "ZON DIBUKA",
        game_over: "TAMAT PERMAINAN",
        btn_continue: "TERUSKAN",
        btn_retry: "CUBA LAGI",
        win_title: "MISI SELESAI",
        win_desc: "Emosi bangunan telah dipulihkan. Legasi Geografi kekal dari 1922 hingga kini.",
        next_btn: "Teruskan",
        
        l1_intro: "Perasaan ingin tahu membawa anda ke sini... Adakah ini lukisan Van Gogh?",
        l1_star1: "„ÄêGema 2005„Äë\nBangunan ini dirasmikan pada 2005. Lihat bumbung curam dan lubang pengudaraan itu, ia mengekalkan estetika kolonial untuk iklim tropika.",
        
        l2_intro: "Bilik ini kelihatan usang... Penuh dengan peralatan lama.",
        l2_star1: "„ÄêWarisan 1922„Äë\nDi sini terletaknya jiwa SITC. Geografi adalah antara subjek teras terawal, mengajar guru Melayu memahami tanah air dan dunia.",
        
        l3_intro: "Ruang semakin herot! Arca di dinding seakan hidup! Lari!",
        l3_star1: "„ÄêEvolusi Eksplorasi„Äë\nArca timbul ini menceritakan sejarah eksplorasi. Dari peta manual ke sistem GIS moden, ilmu geografi terus berkembang.",
        
        level1_complete: "„ÄêBab 1: Kebangkitan„Äë\nAnda mengumpulkan semua serpihan memori di kawasan ini. Bangunan itu menjawab, bintang di dinding mula mengalir, seolah-olah sesuatu akan bangkit.\n\n" +
                         "Makmal Geografi ini merupakan pusat kecemerlangan di bawah Fakulti Sains Kemanusiaan yang dirasmikan pada tahun 2005 bagi meneruskan legasi pengajian Geografi yang telah bermula sejak era Sultan Idris Training College (SITC) pada tahun 1922.\n\n" +
                         "Disiplin Geografi mempunyai sejarah yang sangat signifikan di Tanjong Malim kerana ia merupakan antara subjek teras terawal yang diajar kepada guru-guru Melayu untuk memahami pemetaan, sumber alam, dan geopolitik negara.",
        
        level2_complete: "„ÄêBab 2: Kenangan„Äë\nDengan lebih banyak memori dipulihkan, masa lalu bangunan menjadi lebih jelas. Jiwa tahun 1922 dan nyawa baru tahun 2005 bersatu di sini.\n\n" +
                         "Dari aspek reka bentuk, bangunan ini mengekalkan estetika kolonial melalui struktur bumbung curam dan lubang pengudaraan ikonik, namun diperkasakan dengan arca timbul unik pada dinding luar yang memaparkan peta dunia sebagai simbol sejarah eksplorasi manusia.\n\n" +
                         "Integrasi ini melambangkan transisi ilmu daripada kaedah pemetaan manual tradisional kepada teknologi Sistem Maklumat Geografi (GIS) yang serba moden.",
        
        level3_complete: "„ÄêBab Akhir: Warisan„Äë\nSemua memori telah dikumpulkan sepenuhnya. Emosi bangunan telah tenang sepenuhnya, warisan Geografi akan berterusan selamanya.\n\n" +
                         "Kehadiran bangunan ini membangkitkan rasa takzim terhadap kesinambungan intelektual yang telah memartabatkan pendidikan geografi tanah air selama lebih satu abad.\n\n" +
                         "Ia berdiri teguh sebagai simbol kebanggaan yang menyatukan nostalgia perjuangan pendidik terdahulu dengan aspirasi akademik mahasiswa masa kini.\n\n" +
                         "Perasaan cinta akan warisan sejarah ini memperkukuh azam kami untuk terus memelihara kelestarian bumi serta memartabatkan ilmu geografi demi masa depan generasi akan datang.",
    },
    EN: {
        ui_score: "COLLECTED",
        ui_lives: "LIVES",
        level_cleared: "AREA CLEARED",
        game_over: "GAME OVER",
        btn_continue: "NEXT ROOM",
        btn_retry: "TRY AGAIN",
        win_title: "MEMORY RESTORED",
        win_desc: "You have soothed the building's emotions. The legacy of Geography lives on.",
        next_btn: "Continue",
        
        l1_intro: "Curiosity led you inside... Is this a Van Gogh painting?",
        l1_star1: "„ÄêEchoes of 2005„Äë\nBuilt in 2005, this lab features steep roofs and iconic ventilation holes, preserving colonial aesthetics for the tropical climate.",
        
        l2_intro: "The room feels older... cluttered with vintage equipment.",
        l2_star1: "„ÄêLegacy of 1922„Äë\nThis site inherits the soul of SITC. Geography was a core subject, teaching Malay teachers to understand their land and geopolitics.",
        
        l3_intro: "Reality is twisting! The wall reliefs are moving! Run!",
        l3_star1: "„ÄêEvolution of Exploration„Äë\nThe wall reliefs (Arca Timbul) tell the story of exploration. From manual mapping to modern GIS, our quest for knowledge never ends.",
        
        level1_complete: "„ÄêChapter 1: Awakening„Äë\nYou collected all memory fragments in this area. The building responds, stars on walls begin to flow as if something is awakening.\n\n" +
                         "This Geography Laboratory is a center of excellence under the Faculty of Human Sciences inaugurated in 2005 to continue the legacy of Geography studies that began since the era of Sultan Idris Training College (SITC) in 1922.\n\n" +
                         "The discipline of Geography has a very significant history in Tanjong Malim as it was one of the earliest core subjects taught to Malay teachers to understand mapping, natural resources, and national geopolitics.",
        
        level2_complete: "„ÄêChapter 2: Remembrance„Äë\nWith more memories restored, the building's past becomes clearer. The soul of 1922 and new life of 2005 intertwine here.\n\n" +
                         "In terms of design, this building preserves colonial aesthetics through its steep roof structure and iconic ventilation holes, yet is strengthened by unique bas-reliefs on the exterior walls displaying a world map as a symbol of human exploration history.\n\n" +
                         "This integration symbolizes the transition of knowledge from traditional manual mapping methods to modern Geographic Information System (GIS) technology.",
        
        level3_complete: "„ÄêFinal Chapter: Legacy„Äë\nAll memories have been collected. The building's emotions are completely soothed, the legacy of Geography will continue forever.\n\n" +
                         "The presence of this building evokes reverence for the intellectual continuity that has elevated geography education in the homeland for over a century.\n\n" +
                         "It stands proudly as a symbol of pride that unites the nostalgia of previous educators' struggles with the academic aspirations of today's students.\n\n" +
                         "This love for historical heritage strengthens our resolve to continue preserving earth's sustainability and elevating geography knowledge for future generations.",
    }
};

/**
 * ËµÑÊ∫êÁÆ°ÁêÜ‰∏éÂàùÂßãÂåñ
 */
const bgImg = new Image();
const maskImg = new Image();
const levelStoryImgs = [];

// Áé©ÂÆ∂ÊñπÂêëÂõæÁâá
const playerImgs = {
    up: new Image(),
    down: new Image(),
    left: new Image(),
    right: new Image()
};

// È¨ºÊñπÂêëÂõæÁâá
const ghostImgs = {
    up: new Image(),
    down: new Image(),
    left: new Image(),
    right: new Image()
};

// È¢ÑÂä†ËΩΩÁé©ÂÆ∂ÂõæÁâá
playerImgs.up.src = 'p_up.png';
playerImgs.down.src = 'p_down.png';
playerImgs.left.src = 'p_left.png';
playerImgs.right.src = 'p_right.png';

// È¢ÑÂä†ËΩΩÈ¨ºÂõæÁâá
ghostImgs.up.src = 'g_up.png';
ghostImgs.down.src = 'g_down.png';
ghostImgs.left.src = 'g_left.png';
ghostImgs.right.src = 'g_right.png';

// Ê∑ªÂä†Âä†ËΩΩÁä∂ÊÄÅË∑üË∏™
playerImgs.up.loaded = false;
playerImgs.down.loaded = false;
playerImgs.left.loaded = false;
playerImgs.right.loaded = false;

ghostImgs.up.loaded = false;
ghostImgs.down.loaded = false;
ghostImgs.left.loaded = false;
ghostImgs.right.loaded = false;

// ËÆæÁΩÆÂä†ËΩΩÂõûË∞É
Object.values(playerImgs).forEach(img => {
    img.onload = () => { img.loaded = true; };
    img.onerror = () => { console.error(`Failed to load ${img.src}`); img.loaded = false; };
});

Object.values(ghostImgs).forEach(img => {
    img.onload = () => { img.loaded = true; };
    img.onerror = () => { console.error(`Failed to load ${img.src}`); img.loaded = false; };
});

// È¢ÑÂä†ËΩΩÂÖ≥Âç°ÊïÖ‰∫ãËÉåÊôØÂõæ
for(let i=0; i<3; i++) {
    const img = new Image();
    img.src = `story_bg${i+1}.jpg`;
    img.onerror = () => {
        console.error(`Failed to load story_bg${i+1}.jpg`);
        img.loaded = false;
    };
    img.onload = () => {
        img.loaded = true;
    };
    levelStoryImgs.push(img);
}

function toggleMusic() {
    const audio = document.getElementById('bgMusic');
    const btn = document.getElementById('music-btn');
    if (!audio) return;
    
    if (musicPlaying) {
        audio.pause();
        btn.textContent = 'üîá';
    } else {
        audio.play().catch(e => {
            console.log('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•:', e);
            alert('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Á°Æ‰øùbgm.mp3Êñá‰ª∂Â≠òÂú®');
        });
        btn.textContent = 'üéµ';
    }
    musicPlaying = !musicPlaying;
}

function selectLang(lang) {
    currentLang = lang;
    document.getElementById('start-screen').classList.add('hidden');
    initLevel(1);
}

function initLevel(lvl) {
    currentLevel = lvl;
    isPaused = true;
    gameRunning = false;
    
    bgImg.src = `bg_level${lvl}.jpg`;
    maskImg.src = `mask_level${lvl}.jpg`;
    
    let loaded = 0;
    const checkLoad = () => {
        loaded++;
        if(loaded === 2) setupGameWorld();
    };
    bgImg.onload = checkLoad;
    maskImg.onload = checkLoad;
    bgImg.onerror = () => { 
        console.error(`Missing bg_level${lvl}.jpg`); 
        checkLoad(); 
    };
    maskImg.onerror = () => { 
        console.error(`Missing mask_level${lvl}.jpg`); 
        checkLoad(); 
    };
}

function setupGameWorld() {
    CANVAS.width = MASK_CANVAS.width = bgImg.naturalWidth;
    CANVAS.height = MASK_CANVAS.height = bgImg.naturalHeight;
    MASK_CTX.drawImage(maskImg, 0, 0);
    CTX.imageSmoothingEnabled = false;

    let startPos = findSafeSpot(100, CANVAS.height/2, PLAYER_SIZE);
    player.x = startPos.x;
    player.y = startPos.y;
    player.invulnerable = 0;
    player.angle = 0;

    ghosts = [];
    let ghostCount = currentLevel;
    for(let i=0; i<ghostCount; i++) {
        let ghostSpawnX = CANVAS.width - 200;
        let ghostSpawnY = 200 + i*150;
        let gPos = findSafeSpot(ghostSpawnX, ghostSpawnY, GHOST_SIZE);
        
        let attempts = 0;
        while(checkCollision(gPos.x, gPos.y, GHOST_SIZE) && attempts < 50) {
            gPos.x = ghostSpawnX + (Math.random() - 0.5) * 200;
            gPos.y = ghostSpawnY + (Math.random() - 0.5) * 100;
            attempts++;
        }
        
        ghosts.push({ 
            x: gPos.x, 
            y: gPos.y, 
            angle: Math.PI, 
            targetX: gPos.x,
            targetY: gPos.y
        });
    }

    generateDotsAndStars();

    showStory(getText(`l${currentLevel}_intro`));
    
    gameRunning = true;
    isPaused = true;
    updateHUD();
    requestAnimationFrame(gameLoop);
}

function generateDotsAndStars() {
    dots = [];
    bigStars = [];
    let w = CANVAS.width;
    let h = CANVAS.height;

    // ‰øÆÂ§çÔºöÁ°Æ‰øùÊòüÊòü‰∏ç‰ºöÁîüÊàêÂú®ÈªëËâ≤Ëâ≤ÂùóÂÜÖ
    for(let y = 60; y < h - 60; y += GRID_SIZE) {
        for(let x = 60; x < w - 60; x += GRID_SIZE) {
            // ‰∏•Ê†ºÊ£ÄÊü•ËØ•‰ΩçÁΩÆÊòØÂê¶ÂÆâÂÖ®Ôºà‰∏çÊòØÂ¢ôÔºâ
            if(!checkCollision(x, y, 8)) {  // ‰ΩøÁî®8ÂÉèÁ¥†‰Ωú‰∏∫ÊòüÊòüÂ§ßÂ∞èËøõË°åÊ£ÄÊü•
                dots.push({ 
                    x: x, 
                    y: y, 
                    active: true,
                    phase: Math.random() * Math.PI * 2,
                    freq: 0.05 + Math.random() * 0.05
                });
            }
        }
    }
    totalDots = dots.length;
    collectedDots = 0;

    // Á°Æ‰øù100%ÁîüÊàêÊòüÁÇπ
    let starSize = 30;
    let attempts = 0;
    let starPos = null;
    
    while(!starPos && attempts < 100) {
        let testX = w/2 + (Math.random() - 0.5) * 300;
        let testY = h/2 + (Math.random() - 0.5) * 200;
        // ‰∏•Ê†ºÊ£ÄÊü•Â§ßÊòüÊòü‰ΩçÁΩÆ
        if(!checkCollision(testX, testY, starSize)) {
            starPos = {x: testX, y: testY};
        }
        attempts++;
    }
    
    if(!starPos) {
        starPos = findSafeSpot(w/2, h/2, starSize);
    }
    
    bigStars.push({ 
        x: starPos.x, 
        y: starPos.y, 
        textKey: `l${currentLevel}_star1`, 
        active: true, 
        size: starSize,
        phase: Math.random() * Math.PI * 2,
        freq: 0.03 + Math.random() * 0.02
    });
}

function update() {
    if(!gameRunning || isPaused) return;

    animationFrame++;
    
    let dx = 0, dy = 0;
    
    if (keys['ArrowUp']) dy -= 1;
    if (keys['ArrowDown']) dy += 1;
    if (keys['ArrowLeft']) dx -= 1;
    if (keys['ArrowRight']) dx += 1;
    
    if (joystick.active) {
        dx = joystick.dx;
        dy = joystick.dy;
    }

    if (dx !== 0 || dy !== 0) {
        let len = Math.hypot(dx, dy);
        if (len > 0.1) {
            player.angle = Math.atan2(dy, dx);
            
            dx = (dx / len) * P_SPEED;
            dy = (dy / len) * P_SPEED;
            moveWithPhysics(player, dx, dy, PLAYER_SIZE);
        }
    }

    ghosts.forEach(g => {
        let tx = player.x - g.x;
        let ty = player.y - g.y;
        let dist = Math.hypot(tx, ty);
        let targetAngle = Math.atan2(ty, tx);

        g.angle = targetAngle;

        let nextX = g.x + Math.cos(g.angle) * G_SPEED;
        let nextY = g.y + Math.sin(g.angle) * G_SPEED;
        
        if (checkCollision(nextX, nextY, GHOST_SIZE)) {
            let found = false;
            for (let offset = 0.5; offset < Math.PI * 2; offset += 0.5) {
                let testAngle1 = g.angle + offset;
                let testAngle2 = g.angle - offset;
                
                nextX = g.x + Math.cos(testAngle1) * G_SPEED;
                nextY = g.y + Math.sin(testAngle1) * G_SPEED;
                if (!checkCollision(nextX, nextY, GHOST_SIZE)) {
                    g.angle = testAngle1;
                    found = true;
                    break;
                }
                
                nextX = g.x + Math.cos(testAngle2) * G_SPEED;
                nextY = g.y + Math.sin(testAngle2) * G_SPEED;
                if (!checkCollision(nextX, nextY, GHOST_SIZE)) {
                    g.angle = testAngle2;
                    found = true;
                    break;
                }
            }
            if (!found) {
                g.angle += 0.1;
                return;
            }
        }

        moveWithPhysics(g, Math.cos(g.angle)*G_SPEED, Math.sin(g.angle)*G_SPEED, GHOST_SIZE);

        if (dist < PLAYER_SIZE + GHOST_SIZE && player.invulnerable <= 0) {
            playerHit();
        }
    });

    if (player.invulnerable > 0) player.invulnerable--;

    dots.forEach(d => {
        if (d.active && Math.hypot(player.x - d.x, player.y - d.y) < PLAYER_SIZE + 5) {
            d.active = false;
            collectedDots++;
            updateHUD();
        }
    });

    bigStars.forEach(s => {
        if (s.active && Math.hypot(player.x - s.x, player.y - s.y) < PLAYER_SIZE + 10) {
            s.active = false;
            let text = getText(s.textKey);
            showStory(text);
        }
    });

    let progress = collectedDots / totalDots;
    if (progress >= 0.8 && player.x > CANVAS.width - 150) {
        levelWin();
    }
}

function getDirectionFromAngle(angle) {
    const directions = ['right', 'down', 'left', 'up'];
    const index = Math.round(angle / (Math.PI / 2)) & 3;
    return directions[index];
}

function drawStar(x, y, size, color, star) {
    const blink = (Math.sin(animationFrame * star.freq + star.phase) + 1) * 0.5;
    const opacity = 0.4 + blink * 0.6;
    
    CTX.save();
    CTX.globalAlpha = opacity;
    CTX.fillStyle = color;
    
    const spikes = 5;
    const outerRadius = size;
    const innerRadius = size * 0.5;
    
    CTX.beginPath();
    for (let i = 0; i < spikes * 2; i++) {
        const radius = i % 2 === 0 ? outerRadius : innerRadius;
        const angle = (i * Math.PI) / spikes;
        const px = x + Math.cos(angle) * radius;
        const py = y + Math.sin(angle) * radius;
        
        if (i === 0) {
            CTX.moveTo(px, py);
        } else {
            CTX.lineTo(px, py);
        }
    }
    CTX.closePath();
    CTX.fill();
    
    CTX.restore();
}

function draw() {
    CTX.clearRect(0, 0, CANVAS.width, CANVAS.height);
    CTX.drawImage(bgImg, 0, 0);

    dots.forEach(d => {
        if(d.active) {
            drawStar(d.x, d.y, 8, "#f9d71c", d);
        }
    });

    bigStars.forEach(s => {
        if(s.active) {
            CTX.shadowBlur = 15;
            CTX.shadowColor = "#f9d71c";
            drawStar(s.x, s.y, s.size || 12, "#fff", s);
            CTX.shadowBlur = 0;
        }
    });

    const playerDir = getDirectionFromAngle(player.angle);
    let playerImgToDraw = null;
    
    switch(playerDir) {
        case 'up': playerImgToDraw = playerImgs.up; break;
        case 'down': playerImgToDraw = playerImgs.down; break;
        case 'left': playerImgToDraw = playerImgs.left; break;
        case 'right': playerImgToDraw = playerImgs.right; break;
    }
    
    if (playerImgToDraw && playerImgToDraw.complete && playerImgToDraw.loaded !== false) {
        if (Math.floor(player.invulnerable / 5) % 2 === 0) {
            CTX.drawImage(playerImgToDraw, player.x - PLAYER_SIZE, player.y - PLAYER_SIZE, PLAYER_SIZE*2, PLAYER_SIZE*2);
        }
    } else {
        if (Math.floor(player.invulnerable / 5) % 2 === 0) {
            CTX.fillStyle = "#0ff";
            CTX.fillRect(player.x - PLAYER_SIZE, player.y - PLAYER_SIZE, PLAYER_SIZE*2, PLAYER_SIZE*2);
        }
    }

    ghosts.forEach(g => {
        const ghostDir = getDirectionFromAngle(g.angle);
        let ghostImgToDraw = null;
        
        switch(ghostDir) {
            case 'up': ghostImgToDraw = ghostImgs.up; break;
            case 'down': ghostImgToDraw = ghostImgs.down; break;
            case 'left': ghostImgToDraw = ghostImgs.left; break;
            case 'right': ghostImgToDraw = ghostImgs.right; break;
        }
        
        CTX.save();
        CTX.translate(g.x, g.y);
        
        if (ghostImgToDraw && ghostImgToDraw.complete && ghostImgToDraw.loaded !== false) {
            CTX.drawImage(ghostImgToDraw, -GHOST_SIZE, -GHOST_SIZE, GHOST_SIZE*2, GHOST_SIZE*2);
        } else {
            CTX.fillStyle = "#000";
            CTX.beginPath(); CTX.arc(0, 0, GHOST_SIZE, 0, Math.PI*2); CTX.fill();
            CTX.strokeStyle = "#f00"; CTX.lineWidth = 2;
            CTX.beginPath(); CTX.moveTo(0,0); CTX.lineTo(10,0); CTX.stroke();
        }
        
        CTX.restore();
    });
}

function isWall(x, y) {
    if (x < 0 || x >= MASK_CANVAS.width || y < 0 || y >= MASK_CANVAS.height) return true;
    return MASK_CTX.getImageData(Math.floor(x), Math.floor(y), 1, 1).data[0] < 120;
}

function checkCollision(x, y, size) {
    let r = size - 1;
    return isWall(x, y) || 
           isWall(x+r, y) || isWall(x-r, y) || 
           isWall(x, y+r) || isWall(x, y-r) ||
           isWall(x+r, y+r) || isWall(x-r, y-r);
}

function moveWithPhysics(entity, dx, dy, size) {
    const steps = 4; 
    let sx = dx / steps;
    let sy = dy / steps;
    for(let i=0; i<steps; i++) {
        if(!checkCollision(entity.x + sx, entity.y, size)) entity.x += sx;
        if(!checkCollision(entity.x, entity.y + sy, size)) entity.y += sy;
    }
}

function findSafeSpot(sx, sy, size) {
    let r = 0;
    while(r < 500) {
        for(let dx = -r; dx <= r; dx += 20) {
            for(let dy = -r; dy <= r; dy += 20) {
                if(!checkCollision(sx+dx, sy+dy, size)) return {x: sx+dx, y: sy+dy};
            }
        }
        r += 50;
    }
    return {x: sx, y: sy};
}

function playerHit() {
    lives--;
    updateHUD();
    if (lives <= 0) {
        showResult(getText('game_over'), getText('btn_retry'), () => location.reload());
    } else {
        player.invulnerable = 120;
        let safe = findSafeSpot(100, CANVAS.height/2, PLAYER_SIZE);
        player.x = safe.x; player.y = safe.y;
        
        ghosts.forEach((g, index) => {
            let ghostSafe = findSafeSpot(CANVAS.width - 200, 200 + index*150, GHOST_SIZE);
            g.x = ghostSafe.x;
            g.y = ghostSafe.y;
        });
        
        alert("OUCH! Â∞èÂøÉÈÇ£‰∫õÈªëÂΩ±...");
    }
}

function levelWin() {
    isPaused = true;
    gameRunning = false;
    document.getElementById('result-modal').classList.add('hidden');
    showLevelStory(currentLevel);
}

function showLevelStory(level) {
    const modal = document.getElementById('level-story-modal');
    const img = document.getElementById('story-bg-img');
    const content = document.getElementById('level-story-content');
    const btn = document.getElementById('story-btn-text');
    
    btn.textContent = getText('next_btn');
    
    const storyIndex = level - 1;
    if (levelStoryImgs[storyIndex] && levelStoryImgs[storyIndex].loaded) {
        img.src = levelStoryImgs[storyIndex].src;
        img.style.display = 'block';
    } else {
        img.style.display = 'none';
    }
    
    const levelStory = getText(`level${level}_complete`);
    content.textContent = levelStory;
    
    modal.classList.remove('hidden');
}

function closeLevelStory() {
    document.getElementById('level-story-modal').classList.add('hidden');
    
    if (currentLevel < 3) {
        initLevel(currentLevel + 1);
    } else {
        showResult(getText('win_title'), getText('btn_retry'), () => location.reload());
    }
}

function showStory(text) {
    isPaused = true;
    document.getElementById('story-content').innerText = text;
    document.getElementById('story-modal').classList.remove('hidden');
}

function closeStory() {
    document.getElementById('story-modal').classList.add('hidden');
    isPaused = false;
}

function showResult(title, btnText, callback) {
    document.getElementById('result-title').innerText = title;
    document.getElementById('result-desc').innerText = "";
    let btn = document.getElementById('next-btn');
    btn.innerText = btnText;
    btn.onclick = callback;
    document.getElementById('result-modal').classList.remove('hidden');
}

function getText(key) {
    return TEXT_DATA[currentLang][key] || key;
}

function updateHUD() {
    let hearts = "";
    for(let i=0; i<lives; i++) hearts += "‚ù§Ô∏è";
    document.getElementById('lives').innerHTML = hearts;
    
    let pct = Math.floor((collectedDots / totalDots) * 100);
    document.getElementById('collect-text').innerText = isNaN(pct) ? "0%" : pct + "%";
    document.getElementById('level-num').innerText = currentLevel;
}

window.addEventListener('keydown', e => {
    keys[e.key] = true;
    if (e.key === ' ') {
        e.preventDefault();
        toggleMusic();
    }
});
window.addEventListener('keyup', e => keys[e.key] = false);

const joyZone = document.getElementById('joystick-zone');
const joyKnob = document.getElementById('joystick-knob');

joyZone.addEventListener('touchstart', e => {
    e.preventDefault();
    let touch = e.touches[0];
    let rect = joyZone.getBoundingClientRect();
    joystick.active = true;
    joystick.originX = rect.left + rect.width/2;
    joystick.originY = rect.top + rect.height/2;
    updateJoystick(touch.clientX, touch.clientY);
}, {passive: false});

joyZone.addEventListener('touchmove', e => {
    e.preventDefault();
    if(joystick.active) updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
}, {passive: false});

const endJoy = e => {
    e.preventDefault();
    joystick.active = false;
    joystick.dx = 0; joystick.dy = 0;
    joyKnob.style.transform = `translate(-50%, -50%)`;
};
joyZone.addEventListener('touchend', endJoy);
joyZone.addEventListener('touchcancel', endJoy);

function updateJoystick(x, y) {
    let maxDist = 40;
    let dx = x - joystick.originX;
    let dy = y - joystick.originY;
    let dist = Math.hypot(dx, dy);
    
    if(dist > maxDist) {
        dx = (dx/dist) * maxDist;
        dy = (dy/dist) * maxDist;
    }
    joystick.dx = dx / maxDist;
    joystick.dy = dy / maxDist;
    
    joyKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
}

function gameLoop() {
    animationFrame++;
    update();
    draw();
    frameId = requestAnimationFrame(gameLoop);
}

console.log('Game starting...');
console.log('Please ensure these files exist in the same directory:');
console.log('- p_up.png, p_down.png, p_left.png, p_right.png (player images)');
console.log('- g_up.png, g_down.png, g_left.png, g_right.png (ghost images)');
console.log('- bg_start.jpg (start screen background)');
console.log('- bg_level1.jpg, bg_level2.jpg, bg_level3.jpg (level backgrounds)');
console.log('- mask_level1.jpg, mask_level2.jpg, mask_level3.jpg (collision masks)');
console.log('- story_bg1.jpg, story_bg2.jpg, story_bg3.jpg (story backgrounds)');
console.log('- bgm.mp3 (background music)');

</script>
</body>
</html>